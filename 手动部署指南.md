# 手动部署指南

## 问题分析

502错误通常是因为：
1. **后端服务没有启动**
2. **后端使用了错误的配置文件**（没有使用生产环境配置）
3. **Nginx代理配置不正确**
4. **数据库连接失败**

## 手动打包步骤

### 1. 本地打包前端

```powershell
cd client
npm install
npm run build
```

打包后的文件在 `client/dist/` 目录

### 2. 本地打包后端

```powershell
cd server
mvn clean package -DskipTests
```

打包后的jar文件在 `server/target/blog-server-1.0.0.jar`

### 3. 检查生产环境配置

**重要**：确保 `server/src/main/resources/application-prod.yml` 中的数据库配置正确：

```yaml
datasource:
  url: jdbc:mysql://localhost:3306/blog_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
  username: blog_user  # 修改为你的实际数据库用户名
  password: your_secure_password  # 修改为你的实际数据库密码
```

### 4. 上传到服务器

```bash
# 上传前端文件
scp -r client/dist/* root@your_server_ip:/opt/my-blog/frontend/

# 上传后端jar包
scp server/target/blog-server-1.0.0.jar root@your_server_ip:/opt/my-blog/backend/
```

## 服务器端配置

### 1. 检查后端服务状态

```bash
# 查看服务状态
sudo systemctl status my-blog

# 查看服务日志
sudo journalctl -u my-blog -n 50 --no-pager

# 或者查看日志文件
tail -f /opt/my-blog/logs/backend.log
tail -f /opt/my-blog/logs/backend-error.log
```

### 2. 修复systemd服务配置

编辑 `/etc/systemd/system/my-blog.service`：

```ini
[Unit]
Description=My Blog Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/my-blog/backend
# 重要：添加 --spring.profiles.active=prod 使用生产环境配置
ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m --spring.profiles.active=prod /opt/my-blog/backend/blog-server-1.0.0.jar
Restart=always
RestartSec=10
StandardOutput=append:/opt/my-blog/logs/backend.log
StandardError=append:/opt/my-blog/logs/backend-error.log

[Install]
WantedBy=multi-user.target
```

**关键修改**：在 `ExecStart` 中添加 `--spring.profiles.active=prod`

### 3. 重新加载并启动服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 停止旧服务
sudo systemctl stop my-blog

# 启动服务
sudo systemctl start my-blog

# 查看状态
sudo systemctl status my-blog

# 查看实时日志
sudo journalctl -u my-blog -f
```

### 4. 检查后端是否启动成功

```bash
# 检查8080端口是否监听
netstat -tlnp | grep 8080
# 或
ss -tlnp | grep 8080

# 测试后端接口
curl http://localhost:8080/api/health
```

### 5. 检查Nginx配置

确保 `/etc/nginx/conf.d/my-blog.conf` 配置正确：

```nginx
server {
    listen 80;
    server_name moxiaofan.vip;

    # 前端静态文件
    location /my-blog/ {
        alias /opt/my-blog/frontend/;
        try_files $uri $uri/ /my-blog/index.html;
        index index.html;
    }

    # 后端API代理
    location /my-blog/api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

**重要**：`proxy_pass http://localhost:8080/api/;` 中的 `/api/` 是必需的，因为后端配置了 `context-path: /api`

### 6. 测试Nginx配置并重载

```bash
# 测试Nginx配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

## 常见问题排查

### 问题1：后端服务启动失败

**检查日志**：
```bash
tail -f /opt/my-blog/logs/backend-error.log
```

**常见原因**：
- 数据库连接失败（检查用户名密码）
- 端口被占用
- Java版本不对（需要JDK 17+）

### 问题2：502 Bad Gateway

**检查步骤**：
1. 后端服务是否运行：`sudo systemctl status my-blog`
2. 8080端口是否监听：`netstat -tlnp | grep 8080`
3. 后端接口是否可访问：`curl http://localhost:8080/api/health`
4. Nginx错误日志：`sudo tail -f /var/log/nginx/error.log`

### 问题3：数据库连接失败

**检查**：
1. MySQL是否运行：`sudo systemctl status mysql`
2. 数据库用户是否存在：`mysql -u root -p` 然后 `SELECT User FROM mysql.user;`
3. 数据库是否存在：`SHOW DATABASES;`
4. 修改 `application-prod.yml` 中的数据库配置

### 问题4：前端页面空白或404

**检查**：
1. 前端文件是否上传：`ls -la /opt/my-blog/frontend/`
2. Nginx配置中的路径是否正确
3. 文件权限：`sudo chown -R root:root /opt/my-blog/frontend`

## 快速修复脚本

在服务器上执行：

```bash
#!/bin/bash
# 修复部署问题

# 1. 停止服务
sudo systemctl stop my-blog

# 2. 更新systemd配置（添加生产环境配置）
sudo sed -i 's|ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m /opt/my-blog/backend/blog-server-1.0.0.jar|ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m --spring.profiles.active=prod /opt/my-blog/backend/blog-server-1.0.0.jar|' /etc/systemd/system/my-blog.service

# 3. 重新加载systemd
sudo systemctl daemon-reload

# 4. 启动服务
sudo systemctl start my-blog

# 5. 查看状态
sudo systemctl status my-blog

# 6. 查看日志
echo "=== 服务状态 ==="
sudo systemctl status my-blog --no-pager
echo ""
echo "=== 最近日志 ==="
sudo journalctl -u my-blog -n 30 --no-pager
```

## 验证部署

1. **检查后端**：`curl http://localhost:8080/api/health`
2. **检查前端**：访问 `https://moxiaofan.vip/my-blog/`
3. **检查API**：浏览器开发者工具中查看网络请求是否成功
